{% extends "base.html" %}

{% block head %}
<style>
    .reading-options {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #ffffff;
        padding: 12px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        z-index: 1000;
        width: 200px;
    }

    .reading-options .form-group {
        margin-bottom: 10px;
    }

    .reading-options label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin-bottom: 6px;
    }

    .reading-options select {
        width: 100%;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #fff;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 28px;
    }

    .reading-options select:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 2px rgba(0,123,255,.25);
    }

    /* Dark mode styles */
    body.dark-mode .reading-options {
        background: #2d3136;
        border: 1px solid #404040;
    }

    body.dark-mode .reading-options label {
        color: #e0e0e0;
    }

    body.dark-mode .reading-options select {
        background-color: #23272b;
        border-color: #404040;
        color: #e0e0e0;
    }

    /* Premium content styles */
    .premium-content-lock {
        position: relative;
        min-height: 200px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
    }

    .premium-content-lock i {
        font-size: 3rem;
        color: #ffd700;
        margin-bottom: 1rem;
    }

    .premium-content-lock h3 {
        color: #333;
        margin-bottom: 1rem;
    }

    .premium-content-lock p {
        color: #666;
        margin-bottom: 1.5rem;
    }

    body.dark-mode .premium-content-lock {
        background: rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .premium-content-lock h3 {
        color: #e0e0e0;
    }

    body.dark-mode .premium-content-lock p {
        color: #b0b0b0;
    }

    .premium-badge {
        background: linear-gradient(45deg, #ffd700, #ffa500);
        color: #000;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>

{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 position-relative">
            <!-- Story Header -->
            <div class="mb-4">
                <div class="d-flex align-items-center mb-2">
                    <img src="{{ url_for('static', filename='uploads/' + story.author.profile_picture) if story.author.profile_picture else url_for('static', filename='images/default-avatar.jpg') }}" 
                         class="rounded-circle me-2" width="32" height="32" alt="{{ story.author.username }}">
                    <a href="{{ url_for('main.profile', username=story.author.username) }}" class="text-decoration-none text-dark">
                        {{ story.author.username }}
                    </a>
                    <span class="badge bg-secondary ms-2">{{ story.writing_type|capitalize }}</span>
                    {% if story.is_premium %}
                    <span class="premium-badge ms-2">
                        <i class="fas fa-crown"></i> Premium
                    </span>
                    {% endif %}
                </div>
                <h1 class="h2 mb-3">{{ story.title }}</h1>
                {% if story.writing_type == 'poetry' and story.form_type %}
                <span class="badge bg-info mb-2">{{ story.form_type|capitalize }}</span>
                {% endif %}
                {% if story.writing_type == 'quote' %}
                <div class="mb-2">
                    {% if story.quote_author %}<span class="text-muted">— {{ story.quote_author }}</span>{% endif %}
                    {% if story.quote_source %}<span class="text-muted ms-2"><i>({{ story.quote_source }})</i></span>{% endif %}
                    {% if story.quote_category %}<span class="badge bg-secondary ms-2">{{ story.quote_category|capitalize }}</span>{% endif %}
                </div>
                {% endif %}
                {% if story.writing_type == 'essay' %}
                {% if story.subtitle %}<div class="lead mb-2 text-muted">{{ story.subtitle }}</div>{% endif %}
                {% if story.essay_category %}<span class="badge bg-info mb-2">{{ story.essay_category|capitalize }}</span>{% endif %}
                {% endif %}
                {% if story.writing_type == 'other' and story.custom_type %}
                <span class="badge bg-info mb-2">{{ story.custom_type|capitalize }}</span>
                {% endif %}
            </div>

            <!-- Story Content -->
            {% if story.is_premium and current_user.is_authenticated and current_user != story.author %}
                {% if unlocked %}
            <div class="story-content mb-4 position-relative" id="storyContent">
                    <!-- Three-dot menu for reading options -->
                    <div class="dropdown position-absolute" style="top: 0.5rem; right: 0.5rem; z-index: 10;">
                        <button class="btn btn-sm btn-light border-0" type="button" id="readingOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Reading options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="readingOptionsDropdown" style="min-width: 200px;">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="btn-group me-2" role="group" aria-label="Font size controls">
                                    <button type="button" id="decreaseFont" class="btn btn-outline-secondary btn-sm" tabindex="0" aria-label="Decrease font size">&minus;</button>
                                    <button type="button" id="increaseFont" class="btn btn-outline-secondary btn-sm" tabindex="0" aria-label="Increase font size">&plus;</button>
                                </div>
                            </div>
                            <div>
                                <select id="bgColorDropdown" class="form-select form-select-sm bg-white border rounded" style="width: 100%; min-width: 90px;">
                                    <option value="#ffffff">White</option>
                                    <option value="#1a1a1a">Dark</option>
                                    <option value="#f4ecd8">Sepia</option>
                                    <option value="#edf2ff">Cool</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    {% if story.writing_type == 'poetry' %}
                    <div class="poetry-content" style="white-space: pre-line; font-family: 'Georgia', serif; font-size: 1.2em;">
                        {{ story.content|safe }}
                        {% if story.notes %}
                        <div class="alert alert-secondary mt-3"><strong>Author Notes:</strong> {{ story.notes }}</div>
                        {% endif %}
                    </div>
                    {% elif story.writing_type == 'quote' %}
                    <blockquote class="blockquote mb-4">
                        <p class="mb-0">{{ story.content|safe }}</p>
                        {% if story.quote_author %}<footer class="blockquote-footer">{{ story.quote_author }}</footer>{% endif %}
                    </blockquote>
                    {% if story.quote_source %}
                    <p class="text-muted small">Source: {{ story.quote_source }}</p>
                    {% endif %}
                    {% elif story.writing_type == 'essay' %}
                    <div class="essay-content">
                        {{ story.content|safe }}
                        {% if story.references %}
                        <div class="mt-4">
                            <h5 class="fw-bold">References:</h5>
                            <p class="small text-muted">{{ story.references }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% elif story.writing_type == 'webnovel' %}
                    <div class="alert alert-info">
                        This is a webnovel. Please navigate to the novel's dedicated page for reading chapters.
                        <a href="{{ url_for('main.novel_detail_slug', novel_slug=story.novel.slug) }}" class="alert-link">Go to Novel Page</a>
                    </div>
                    {% else %}
                    <div class="regular-story-content">
                        {{ story.content|safe }}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="premium-content-lock">
                    <i class="fas fa-lock"></i>
                    <h3>Premium Content</h3>
                    <p>This content is locked. Unlock for 50 points.</p>
                    <p class="text-muted">Your current points: {{ current_user.points }}</p>
                    {% if current_user.points >= 50 %}
                    <form action="{{ url_for('main.unlock_story', story_id=story.id) }}" method="POST">
                        <button type="submit" class="btn btn-warning btn-lg">Unlock for 50 points</button>
                    </form>
                    {% else %}
                    <p class="text-danger">You do not have enough points to unlock this story.</p>
                    <a href="{{ url_for('main.redeem_points') }}" class="btn btn-secondary">Earn More Points</a>
                    {% endif %}
                </div>
                {% endif %}
            {% elif story.is_premium and not current_user.is_authenticated %}
            <div class="premium-content-lock">
                <i class="fas fa-lock"></i>
                <h3>Premium Content</h3>
                <p>This content is locked. Please log in to unlock using points.</p>
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-lg">Log In</a>
                </div>
                {% else %}
            <div class="story-content mb-4 position-relative" id="storyContent">
                <!-- Three-dot menu for reading options -->
                <div class="dropdown position-absolute" style="top: 0.5rem; right: 0.5rem; z-index: 10;">
                    <button class="btn btn-sm btn-light border-0" type="button" id="readingOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Reading options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="readingOptionsDropdown" style="min-width: 200px;">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="btn-group me-2" role="group" aria-label="Font size controls">
                                <button type="button" id="decreaseFont" class="btn btn-outline-secondary btn-sm" tabindex="0" aria-label="Decrease font size">&minus;</button>
                                <button type="button" id="increaseFont" class="btn btn-outline-secondary btn-sm" tabindex="0" aria-label="Increase font size">&plus;</button>
                            </div>
                        </div>
                        <div>
                            <select id="bgColorDropdown" class="form-select form-select-sm bg-white border rounded" style="width: 100%; min-width: 90px;">
                                <option value="#ffffff">White</option>
                                <option value="#1a1a1a">Dark</option>
                                <option value="#f4ecd8">Sepia</option>
                                <option value="#edf2ff">Cool</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% if story.writing_type == 'poetry' %}
                <div class="poetry-content" style="white-space: pre-line; font-family: 'Georgia', serif; font-size: 1.2em;">
                    {{ story.content|safe }}
                    {% if story.notes %}
                    <div class="alert alert-secondary mt-3"><strong>Author Notes:</strong> {{ story.notes }}</div>
                    {% endif %}
                </div>
                {% elif story.writing_type == 'essay' %}
                <div class="essay-content">
                    {{ story.content|safe }}
                    {% if story.references %}
                    <div class="mt-4">
                        <h5 class="fw-bold">References:</h5>
                        <p class="small text-muted">{{ story.references }}</p>
                    </div>
                    {% endif %}
                </div>
                {% elif story.writing_type == 'webnovel' %}
                <div class="alert alert-info">
                    This is a webnovel. Please navigate to the novel's dedicated page for reading chapters.
                    <a href="{{ url_for('main.novel_detail_slug', novel_slug=story.novel.slug) }}" class="alert-link">Go to Novel Page</a>
                </div>
                {% else %}
                <div class="regular-story-content">
                    {{ story.content|safe }}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Story Footer -->
            <div class="story-footer">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <form method="POST" action="{{ url_for('main.like_story', story_id=story.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-heart{% if current_user.is_authenticated and story in current_user.liked_stories %} text-danger{% endif %}"></i>
                                <span class="ms-1">{{ story.likes }}</span>
                            </button>
                        </form>
                    </div>
                    {% if current_user.is_authenticated %}
                        {% if story in current_user.saved_stories %}
                            <form action="{{ url_for('main.unsave_story', story_id=story.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-outline-secondary btn-sm" 
                                    aria-label="Remove {{ story.title }} from reading list">
                                    <i class="fas fa-bookmark me-1" aria-hidden="true"></i>Saved
                                </button>
                            </form>
                        {% else %}
                        <a href="{{ url_for('main.save_story', story_id=story.id) }}" 
                            class="btn btn-outline-secondary btn-sm" 
                            role="button" 
                            aria-label="Save {{ story.title }} to reading list">
                            <i class="far fa-bookmark me-1" aria-hidden="true"></i>Save
                        </a>
                        {% endif %}
                    {% endif %}
                    <div class="text-muted">
                        <small>
                            <i class="fas fa-eye me-1"></i>{{ story.views }} views
                            <span class="mx-2">•</span>
                            <i class="fas fa-clock me-1"></i>{{ story.created_at.strftime('%B %d, %Y') }}
                        </small>
                    </div>
                </div>

                <!-- Tags -->
                {% if story.tags %}
                <div class="mb-4">
                    {% for tag in story.tags %}
                    <a href="{{ url_for('main.tag', tag_name=tag.name) }}" class="badge bg-light text-dark text-decoration-none me-1">
                        #{{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Comments Section -->
                <div class="comments-section mt-4">
                    <h4 class="mb-3">Comments</h4>
                    {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('main.comment', story_id=story.id) }}" class="mb-4">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.content(class="form-control", rows=3, placeholder="Write a comment...") }}
                        </div>
                        {{ form.submit(class="btn btn-primary") }}
                    </form>
                    {% endif %}

                    {% for comment in story.comments.filter_by(parent_id=None).order_by(Comment.created_at.desc()).all() %}
                    <div class="comment mb-3">
                        <div class="d-flex">
                            <img src="{{ url_for('static', filename='uploads/' + comment.author.profile_picture) if comment.author.profile_picture else url_for('static', filename='images/default-avatar.jpg') }}" 
                                 class="rounded-circle me-2" width="32" height="32" alt="{{ comment.author.username }}">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <a href="{{ url_for('main.profile', username=comment.author.username) }}" class="text-decoration-none text-dark fw-bold me-2">
                                        {{ comment.author.username }}
                                    </a>
                                    <small class="text-muted">{{ comment.created_at.strftime('%B %d, %Y') }}</small>
                                    {% if current_user.is_authenticated and (current_user == comment.author or current_user == story.author) %}
                                    <div class="ms-auto">
                                        <a href="{{ url_for('main.edit_comment', comment_id=comment.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <form method="POST" action="{{ url_for('main.delete_comment', comment_id=comment.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this comment?')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                </div>
                                <p class="mb-1">{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Font size control with segmented buttons
        const storyContent = document.getElementById('storyContent');
        const decreaseFontBtn = document.getElementById('decreaseFont');
        const increaseFontBtn = document.getElementById('increaseFont');
        // Font size states
        const fontSizes = ['small', 'medium', 'large'];
        let currentFontIndex = 1; // default to medium
        function applyFontSize(idx) {
            switch(fontSizes[idx]) {
                case 'small':
                    storyContent.style.fontSize = '0.9em';
                    break;
                case 'medium':
                    storyContent.style.fontSize = '1em';
                    break;
                case 'large':
                    storyContent.style.fontSize = '1.2em';
                    break;
            }
        }
        applyFontSize(currentFontIndex);
        decreaseFontBtn.addEventListener('click', function() {
            if (currentFontIndex > 0) {
                currentFontIndex--;
                applyFontSize(currentFontIndex);
            }
        });
        increaseFontBtn.addEventListener('click', function() {
            if (currentFontIndex < fontSizes.length - 1) {
                currentFontIndex++;
                applyFontSize(currentFontIndex);
            }
        });

        // Background color dropdown logic (unchanged)
        const bgColorDropdown = document.getElementById('bgColorDropdown');
        bgColorDropdown.addEventListener('change', function() {
            const color = this.value;
            storyContent.style.backgroundColor = color;
            // Set text color based on background
            if (color === '#1a1a1a') {
                storyContent.style.color = '#ffffff';
            } else {
                storyContent.style.color = '#000000';
            }
            storyContent.style.padding = '20px';
            storyContent.style.borderRadius = '8px';
        });

        // --- Delayed view increment logic ---
        // Only for non-quote types, not author
        const writingType = '{{ story.writing_type }}';
        const storyId = {{ story.id }};
        const isAuthor = {% if current_user.is_authenticated and current_user.id == story.author_id %}true{% else %}false{% endif %};
        if (writingType !== 'quote' && !isAuthor) {
            setTimeout(function() {
                fetch(`/api/story/${storyId}/increment_view`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    // Optionally update the view count in the UI
                    if (data.success && data.views !== undefined) {
                        const viewEls = document.querySelectorAll('.fa-eye, .stat-value');
                        viewEls.forEach(function(el) {
                            if (el.classList.contains('stat-value')) {
                                el.textContent = data.views;
                            }
                        });
                    }
                });
            }, 10000); // 10 seconds
        }
        // --- End delayed view logic ---
    });
</script>
{% endblock scripts %}